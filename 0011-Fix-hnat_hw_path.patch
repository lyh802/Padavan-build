From b524c4353615c84fa2dcc7591c54db06edefaedc Mon Sep 17 00:00:00 2001
From: lyh802 <lyh802@126.com>
Date: Fri, 9 Jun 2023 22:09:32 +0800
Subject: [PATCH] Fix hnat_hw_path

---
 trunk/linux-4.4.x/drivers/net/ppp/ppp_generic.c   | 2 +-
 trunk/linux-4.4.x/drivers/net/ppp/pppoe.c         | 6 +++---
 trunk/linux-4.4.x/include/net/netfilter/nf_hnat.h | 3 ++-
 trunk/linux-4.4.x/net/8021q/vlan_dev.c            | 5 +++--
 trunk/linux-4.4.x/net/ipv6/ip6_tunnel.c           | 4 ++--
 5 files changed, 11 insertions(+), 9 deletions(-)

diff --git a/trunk/linux-4.4.x/drivers/net/ppp/ppp_generic.c b/trunk/linux-4.4.x/drivers/net/ppp/ppp_generic.c
index db53b43..83e1bf0 100644
--- a/trunk/linux-4.4.x/drivers/net/ppp/ppp_generic.c
+++ b/trunk/linux-4.4.x/drivers/net/ppp/ppp_generic.c
@@ -1157,7 +1157,7 @@ static void ppp_dev_priv_destructor(struct net_device *dev)
 
 static int ppp_hnat_check(struct hnat_hw_path *path)
 {
-        struct ppp *ppp = netdev_priv(path->dev);
+        struct ppp *ppp = netdev_priv(path->real_dev);
         struct ppp_channel *chan;
         struct channel *pch;
 
diff --git a/trunk/linux-4.4.x/drivers/net/ppp/pppoe.c b/trunk/linux-4.4.x/drivers/net/ppp/pppoe.c
index 6701f1d..5ed7a18 100644
--- a/trunk/linux-4.4.x/drivers/net/ppp/pppoe.c
+++ b/trunk/linux-4.4.x/drivers/net/ppp/pppoe.c
@@ -1009,14 +1009,14 @@ static int pppoe_hnat_check(struct ppp_channel *chan,
             !(sk->sk_state & PPPOX_CONNECTED) || !dev)
                 return -ENODEV;
 
-        path->dev = po->pppoe_dev;
+        path->real_dev = po->pppoe_dev;
         path->flags |= HNAT_PATH_PPPOE;
         memcpy(path->eth_src, po->pppoe_dev->dev_addr, ETH_ALEN);
         memcpy(path->eth_dest, po->pppoe_pa.remote, ETH_ALEN);
         path->pppoe_sid = be16_to_cpu(po->num);
 
-        if (path->dev->netdev_ops->ndo_hnat_check)
-                return path->dev->netdev_ops->ndo_hnat_check(path);
+        if (path->real_dev->netdev_ops->ndo_hnat_check)
+                return path->real_dev->netdev_ops->ndo_hnat_check(path);
 
         return 0;
 }
diff --git a/trunk/linux-4.4.x/include/net/netfilter/nf_hnat.h b/trunk/linux-4.4.x/include/net/netfilter/nf_hnat.h
index 80a77ab..7cdd1a0 100644
--- a/trunk/linux-4.4.x/include/net/netfilter/nf_hnat.h
+++ b/trunk/linux-4.4.x/include/net/netfilter/nf_hnat.h
@@ -6,7 +6,8 @@
 #define HNAT_PATH_DSLITE        BIT(3)
 
 struct hnat_hw_path {
-        const struct net_device *dev;
+        const struct net_device *virt_dev;
+        const struct net_device *real_dev;
         u32 flags;
 
         u8 eth_src[ETH_ALEN];
diff --git a/trunk/linux-4.4.x/net/8021q/vlan_dev.c b/trunk/linux-4.4.x/net/8021q/vlan_dev.c
index 9955593..bffd75d 100644
--- a/trunk/linux-4.4.x/net/8021q/vlan_dev.c
+++ b/trunk/linux-4.4.x/net/8021q/vlan_dev.c
@@ -762,7 +762,7 @@ static int vlan_dev_get_iflink(const struct net_device *dev)
 
 static int vlan_dev_hnat_check(struct hnat_hw_path *path)
 {
-	struct net_device *dev = path->dev;
+	struct net_device *dev = path->real_dev;
 	struct vlan_dev_priv *vlan = vlan_dev_priv(dev);
 
 	if (path->flags & HNAT_PATH_VLAN)
@@ -771,7 +771,8 @@ static int vlan_dev_hnat_check(struct hnat_hw_path *path)
 	path->flags |= HNAT_PATH_VLAN;
 	path->vlan_proto = vlan->vlan_proto;
 	path->vlan_id = vlan->vlan_id;
-	path->dev = vlan->real_dev;
+	path->virt_dev = dev;
+	path->real_dev = vlan->real_dev;
 
 	if (vlan->real_dev->netdev_ops->ndo_hnat_check)
 		return vlan->real_dev->netdev_ops->ndo_hnat_check(path);
diff --git a/trunk/linux-4.4.x/net/ipv6/ip6_tunnel.c b/trunk/linux-4.4.x/net/ipv6/ip6_tunnel.c
index 3009981..8056512 100644
--- a/trunk/linux-4.4.x/net/ipv6/ip6_tunnel.c
+++ b/trunk/linux-4.4.x/net/ipv6/ip6_tunnel.c
@@ -1680,14 +1680,14 @@ EXPORT_SYMBOL(ip6_tnl_get_iflink);
 static int ipip6_dev_hnat_check(struct hnat_hw_path *path)
 {
 
-	struct net_device *dev = path->dev;
+	struct net_device *dev = path->real_dev;
 	struct ip6_tnl *tnl = netdev_priv(dev);
 
 	if (path->flags & HNAT_PATH_DSLITE)
 		return -EEXIST;
 
 	path->flags |= HNAT_PATH_DSLITE;
-	path->dev = tnl->dev;
+	path->real_dev = tnl->dev;
 
 	return 0;
 
-- 
2.32.0.windows.2

